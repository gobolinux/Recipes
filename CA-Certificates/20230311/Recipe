# Recipe for version 20230311 by Sean Summers <seansummers@gmail.com>, on Fri 05 May 2023 09:38:40 PM EDT
# Recipe (MakeRecipe) for CA-Certificates by Jean-Michel T.Dydak <jm.dev@gmx.com>, on Tue 01 Feb 2022 03:13:20 PM GMT
compile_version=017-GIT

urls=(
   "https://archive.mozilla.org/pub/security/nss/releases/NSS_3_86_RTM/src/nss-3.86.tar.gz"
   "https://debian.osuosl.org/debian/pool/main/c/ca-certificates/ca-certificates_20230311.tar.xz"
)

file_sizes=(
   71423531
   257772
)
file_md5s=(
   1f8cb0771f0ee64a4e891745b37f3098
   fc1c3ec0067385f0be8ac7f6e670a0f8
)

dir='nss-3.86'
recipe_type=makefile
unpack_files=inside_first

do_patch() {
   patch -i $recipedir/01-ca-certificates-20230311-root.patch -p1
   pushd $sourcedir/ca-certificates/mozilla >/dev/null || die
     patch -i $recipedir/02-ca-certificates-20230311-no-cryptography.patch
   popd >/dev/null || die
}

pre_build() {
   sed -i -e 's:/usr/share/ca-certificates:/share/ca-certificates:' ca-certificates/Makefile
   sed -i -e 's:/usr/sbin:/sbin:' ca-certificates/sbin/Makefile
   sed -i -e 's:/usr/share/ca-certificates:/usr/share/ca-certificates/mozilla:' $sourcedir/ca-certificates/sbin/update-ca-certificates
   sed -i -e 's:/usr/local/share/ca-certificates:/usr/share/ca-certificates/mozilla:' $sourcedir/ca-certificates/sbin/update-ca-certificates

   ## Grab the database from the nss sources.
   cp $sourcedir/nss/lib/ckfw/builtins/{certdata.txt,nssckbi.h} $sourcedir/ca-certificates/mozilla || die
}

do_build() {
   pushd $sourcedir/ca-certificates > /dev/null || die
     make
   popd >/dev/null || die
}

pre_install() {
   mkdir -p $target/share/ca-certificates
}

do_install() {
   pushd $sourcedir/ca-certificates > /dev/null || die
     make install DESTDIR="$target"
   popd >/dev/null || die
}

pre_link() {
   mkdir -p $goboSettings/ca-certificates/update.d

   (
      echo "# Automatically generated by Compile."
      echo "# $(date -u)"
      echo "# Do not edit."
      pushd $target/share/ca-certificates/mozilla >/dev/null || die
        find * -name '*.crt' | LC_ALL=C sort
      popd >/dev/null || die
   )  > $settings_target/ca-certificates.conf
}

post_install_message="\n\nIMPORTANT:\nYou must run as root 'sh ${goboSystem}/Index/bin/update-ca-certificates'.\n"
